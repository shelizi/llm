# RAG 文件過濾功能使用指南

## 功能概述

現在您可以在前端控制要查詢的檔案，而不是查詢整個資料庫。這個功能讓您能夠：

- 選擇查詢所有已索引的文檔
- 選擇查詢特定的文檔
- 動態切換查詢範圍

## 功能特點

### 1. 查詢範圍選擇
- **所有文檔**: 查詢整個向量資料庫中的所有已索引文檔
- **指定文檔**: 只在您選擇的特定文檔中進行查詢

### 2. 文檔選擇界面
- 自動載入已索引的文檔列表
- 支援多選文檔
- 提供全選/清除功能
- 即時刷新文檔列表

### 3. 查詢結果優化
- 顯示查詢範圍信息
- 標示結果來源文檔
- 保持相似度評分

## 使用方法

### 前端操作

1. **選擇查詢模式**
   - 點選 "所有文檔" 查詢整個資料庫
   - 點選 "指定文檔" 查詢特定文件

2. **選擇特定文檔** (當選擇 "指定文檔" 模式時)
   - 系統會自動載入已索引的文檔列表
   - 勾選您想要查詢的文檔
   - 使用 "全選" 或 "清除" 按鈕快速操作
   - 點擊 "刷新" 按鈕更新文檔列表

3. **執行查詢**
   - 輸入查詢問題
   - 設定返回結果數量
   - 點擊 "查詢" 按鈕

### API 調用

#### 查詢所有文檔
```bash
curl -X POST "http://localhost:8000/query" \
  -H "Content-Type: application/json" \
  -d '{
    "query": "您的問題",
    "top_k": 5,
    "filenames": []
  }'
```

#### 查詢特定文檔
```bash
curl -X POST "http://localhost:8000/query" \
  -H "Content-Type: application/json" \
  -d '{
    "query": "您的問題",
    "top_k": 5,
    "filenames": ["file1.txt", "file2.pdf"]
  }'
```

#### 獲取已索引文檔列表
```bash
curl -X GET "http://localhost:8000/indexed_files"
```

## 新增的 API 端點

### GET /indexed_files
返回已索引的文檔列表

**回應格式:**
```json
{
  "files": ["file1.txt", "file2.pdf", "file3.docx"]
}
```

### POST /query (更新)
原有的查詢端點，新增了 `filenames` 參數

**請求格式:**
```json
{
  "query": "查詢內容",
  "top_k": 5,
  "filenames": ["可選的文檔名稱列表"]
}
```

**參數說明:**
- `query`: 查詢問題 (必填)
- `top_k`: 返回結果數量，範圍 1-20 (選填，預設 5)
- `filenames`: 要查詢的文檔名稱列表 (選填，空列表表示查詢所有文檔)

## 技術實現

### 後端改進
1. **元數據過濾**: 使用 LlamaIndex 的 MetadataFilters 功能
2. **文檔列表獲取**: 直接從 ChromaDB 集合中提取文檔元數據
3. **向量檢索優化**: 根據選擇的文檔進行過濾查詢

### 前端改進
1. **動態文檔載入**: 自動從後端獲取已索引文檔列表
2. **互動式選擇**: 提供直觀的文檔選擇界面
3. **查詢範圍顯示**: 在結果中明確顯示查詢範圍

## 測試方法

運行測試腳本來驗證功能：

```bash
cd RAG
python test_file_filtering.py
```

測試腳本會：
1. 檢查 API 健康狀態
2. 獲取已索引文檔列表
3. 測試查詢所有文檔
4. 測試查詢特定文檔
5. 驗證結果過濾是否正確

## 注意事項

1. **文檔名稱**: 確保文檔名稱在索引時正確設定
2. **中文文件名**: 完全支援中文文件名，無需特殊處理
3. **重新索引**: 新增文檔後需要重新索引才會出現在列表中
4. **性能**: 查詢特定文檔通常比查詢所有文檔更快
5. **結果準確性**: 限制查詢範圍可能會影響結果的全面性

## 故障排除

### 文檔列表為空
- 確認已有文檔被正確索引
- 檢查文檔元數據中是否包含 filename 字段
- 嘗試重新載入或重啟服務

### 查詢結果不符合預期
- 確認選擇的文檔確實包含相關內容
- 嘗試增加 top_k 值
- 檢查查詢關鍵詞是否合適

### 中文文件名問題
- 如果遇到 "InvalidCharacterError" 或 "btoa" 相關錯誤，請刷新頁面
- 確認瀏覽器支援 UTF-8 編碼
- 檢查文件名是否包含特殊字符

### UI 區域獨立性問題
- 文件管理區域和查詢區域的選擇框是完全獨立的
- 在查詢區域選擇文檔不會影響上方的文件管理選擇
- 如果發現相互影響，請刷新頁面或清除瀏覽器緩存

### API 錯誤
- 確認服務正在運行
- 檢查請求格式是否正確
- 查看服務器日誌了解詳細錯誤信息